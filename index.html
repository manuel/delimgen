<html>
  <head>
    <script type="module">
class Suspension
{
    constructor(handler)
    {
        this.handler = handler;
    }
    get_suspension_handler() { return this.handler; }
}

class Resumption
{
    constructor(handler)
    {
        this.handler = handler;
    }
    get_resumption_handler() { return this.handler; }
}

function* push_prompt(gen)
{
    return yield* push_action(gen, () => gen.next());
}

function* push_delim_subcont(gen, resumption_handler)
{
    return yield* push_action(gen, () => gen.next(new Resumption(resumption_handler)))
}

function* push_action(gen, action)
{
    const res = action();
    if (res.done) {
        return res.value;
    } else {
        const suspension_handler = res.value.get_suspension_handler();
        return yield* suspension_handler(gen);
    }
}

function* take_subcont(suspension_handler)
{
    const resumption = yield new Suspension(suspension_handler);
    const resumption_handler = resumption.get_resumption_handler();
    return yield* resumption_handler();
}

class Outline_mode
{
    *run()
    {
        while (true) {
            const evt = yield* get_next_event();
            console.log(evt);
        }
    }
}

window.onload = () => push_prompt(new Outline_mode().run()).next();

window.onclick = (evt) => inject_event(evt).next();

let saved_coroutine = null;

function* get_next_event()
{
    return yield* take_subcont(function* (gen) { saved_coroutine = gen; });
}

function* inject_event(evt)
{
    if (saved_coroutine !== null) {
        const gen = saved_coroutine;
        saved_coroutine = null;
        return yield* push_delim_subcont(gen, function* () { return evt; });
    } else {
        console.log("dropped event", evt);
    }
}

    </script>
  </head>
</html>
