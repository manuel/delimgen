<html><head><script type="module">
import { run, suspend, resume } from "../index.mjs";
import { sleep } from "../sleep.mjs";
import { get_next_event, inject_event } from "../event.mjs";

/*
 * This demonstrates running multiple independent generators running
 * sleep-loops, and a main generator blocking for events.
 */

function* main()
{
    /*
     * Spawn some pre-existing rects.
     */
    yield* run(rect(100, 200));
    yield* run(rect(200, 300));
    yield* run(rect(300, 400));
    /*
     * Wait for click events, spawn a new rect on each click.
     */
    while (true) {
        const event = yield* get_next_event();
        yield* run(rect(event.pageX, event.pageY));
    }
}

window.onload = () => run(main()).next();

/*
 * Pipe click events into event loop.
 */
window.onclick = (event) => inject_event(event).next();

/*
 * Generator that displays a rectangle, and then runs in an infinite
 * sleep-loop that moves the rectangle a tiny bit on each step.
 */
function* rect(x, y)
{
    const rect = document.createElement("div");
    rect.classList.add("rect");
    rect.style.left = x + "px";
    rect.style.top = y + "px";
    document.body.appendChild(rect);
    const xdelta = rand(0, 5);
    const ydelta = rand(0, 5);
    while (true)
    {
        x += xdelta;
        y += ydelta;
        rect.style.left = x + "px";
        rect.style.top = y + "px";
        yield* sleep(50);
    }
}

function rand(min, max) {
    return Math.random() * (max - min) + min;
}
</script>
<style>.rect { position: absolute; width: 50px; height: 50px; background-color: red; }</style>
</head>
<body><b>Click anywhere to spawn new generators.  View source to see how it works.</b></body>
</html>
